---
interface Props {
  images: string[];
  title: string;
}

const { images, title } = Astro.props;
---

<div class="gallery-container">
  <!-- Thumbnail Grid -->
  <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-3">
    {images.map((image, index) => (
      <button
        class="gallery-thumbnail group"
        data-index={index}
        aria-label={`View ${title} photo ${index + 1} of ${images.length}`}
      >
        <img
          src={image}
          alt={`${title} - Photo ${index + 1}`}
          loading={index < 8 ? "eager" : "lazy"}
          class="w-full h-full object-cover"
        />
        <div class="thumbnail-overlay">
          <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0zM10 7v3m0 0v3m0-3h3m-3 0H7"></path>
          </svg>
        </div>
      </button>
    ))}
  </div>

  <!-- Lightbox Modal -->
  <div id="lightbox" class="lightbox" role="dialog" aria-modal="true" aria-label="Photo gallery viewer" hidden>
    <div class="lightbox-backdrop"></div>

    <div class="lightbox-content">
      <!-- Close Button -->
      <button id="lightbox-close" class="lightbox-close" aria-label="Close gallery">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
        </svg>
      </button>

      <!-- Navigation -->
      <button id="lightbox-prev" class="lightbox-nav lightbox-prev" aria-label="Previous photo">
        <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
        </svg>
      </button>

      <button id="lightbox-next" class="lightbox-nav lightbox-next" aria-label="Next photo">
        <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
        </svg>
      </button>

      <!-- Image Container -->
      <div class="lightbox-image-container">
        <img id="lightbox-image" src="" alt="" class="lightbox-image" />
      </div>

      <!-- Counter -->
      <div class="lightbox-counter">
        <span id="lightbox-current">1</span> / <span id="lightbox-total">{images.length}</span>
      </div>
    </div>
  </div>
</div>

<!-- Store images data for JS -->
<script define:vars={{ images, title }}>
  window.galleryImages = images;
  window.galleryTitle = title;
</script>

<style>
  .gallery-container {
    width: 100%;
  }

  /* Thumbnail Styles */
  .gallery-thumbnail {
    position: relative;
    aspect-ratio: 1;
    overflow: hidden;
    border-radius: 12px;
    cursor: pointer;
    border: none;
    padding: 0;
    background: transparent;
    box-shadow: 0 2px 8px rgba(139, 115, 85, 0.1);
    transition: transform 0.3s ease, box-shadow 0.3s ease;
  }

  .gallery-thumbnail:hover {
    transform: translateY(-4px);
    box-shadow: 0 8px 24px rgba(139, 115, 85, 0.2);
  }

  .gallery-thumbnail img {
    transition: transform 0.4s ease;
  }

  .gallery-thumbnail:hover img {
    transform: scale(1.08);
  }

  .thumbnail-overlay {
    position: absolute;
    inset: 0;
    background: linear-gradient(to top, rgba(61, 79, 71, 0.7), transparent 60%);
    display: flex;
    align-items: center;
    justify-content: center;
    opacity: 0;
    transition: opacity 0.3s ease;
  }

  .gallery-thumbnail:hover .thumbnail-overlay,
  .gallery-thumbnail:focus .thumbnail-overlay {
    opacity: 1;
  }

  /* Lightbox Styles */
  .lightbox {
    position: fixed;
    inset: 0;
    z-index: 9999;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .lightbox[hidden] {
    display: none;
  }

  .lightbox-backdrop {
    position: absolute;
    inset: 0;
    background: rgba(61, 79, 71, 0.95);
    backdrop-filter: blur(8px);
  }

  .lightbox-content {
    position: relative;
    width: 100%;
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 60px 80px;
  }

  .lightbox-close {
    position: absolute;
    top: 20px;
    right: 20px;
    z-index: 10;
    width: 48px;
    height: 48px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: rgba(255, 255, 255, 0.1);
    border: none;
    border-radius: 50%;
    color: white;
    cursor: pointer;
    transition: all 0.3s ease;
  }

  .lightbox-close:hover {
    background: rgba(255, 255, 255, 0.2);
    transform: rotate(90deg);
  }

  .lightbox-nav {
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    z-index: 10;
    width: 56px;
    height: 56px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: rgba(255, 255, 255, 0.1);
    border: none;
    border-radius: 50%;
    color: white;
    cursor: pointer;
    transition: all 0.3s ease;
  }

  .lightbox-nav:hover {
    background: rgba(196, 149, 106, 0.8);
    transform: translateY(-50%) scale(1.1);
  }

  .lightbox-prev {
    left: 20px;
  }

  .lightbox-next {
    right: 20px;
  }

  .lightbox-image-container {
    max-width: 100%;
    max-height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .lightbox-image {
    max-width: 100%;
    max-height: calc(100vh - 140px);
    object-fit: contain;
    border-radius: 12px;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4);
    opacity: 0;
    transform: scale(0.95);
    transition: opacity 0.3s ease, transform 0.3s ease;
  }

  .lightbox-image.loaded {
    opacity: 1;
    transform: scale(1);
  }

  .lightbox-counter {
    position: absolute;
    bottom: 20px;
    left: 50%;
    transform: translateX(-50%);
    padding: 8px 20px;
    background: rgba(255, 255, 255, 0.15);
    border-radius: 20px;
    color: white;
    font-size: 14px;
    font-weight: 500;
    letter-spacing: 0.5px;
  }

  /* Mobile Adjustments */
  @media (max-width: 768px) {
    .lightbox-content {
      padding: 60px 16px;
    }

    .lightbox-nav {
      width: 44px;
      height: 44px;
    }

    .lightbox-prev {
      left: 8px;
    }

    .lightbox-next {
      right: 8px;
    }

    .lightbox-image {
      max-height: calc(100vh - 120px);
      border-radius: 8px;
    }
  }
</style>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const lightbox = document.getElementById('lightbox');
    const lightboxImage = document.getElementById('lightbox-image') as HTMLImageElement;
    const lightboxCurrent = document.getElementById('lightbox-current');
    const closeBtn = document.getElementById('lightbox-close');
    const prevBtn = document.getElementById('lightbox-prev');
    const nextBtn = document.getElementById('lightbox-next');
    const backdrop = document.querySelector('.lightbox-backdrop');
    const thumbnails = document.querySelectorAll('.gallery-thumbnail');

    const images = (window as any).galleryImages as string[];
    const title = (window as any).galleryTitle as string;
    let currentIndex = 0;
    let touchStartX = 0;
    let touchEndX = 0;

    function openLightbox(index: number) {
      currentIndex = index;
      updateImage();
      lightbox?.removeAttribute('hidden');
      document.body.style.overflow = 'hidden';
    }

    function closeLightbox() {
      lightbox?.setAttribute('hidden', '');
      document.body.style.overflow = '';
    }

    function updateImage() {
      if (!lightboxImage || !lightboxCurrent) return;

      lightboxImage.classList.remove('loaded');
      lightboxImage.src = images[currentIndex];
      lightboxImage.alt = `${title} - Photo ${currentIndex + 1}`;
      lightboxCurrent.textContent = String(currentIndex + 1);

      lightboxImage.onload = () => {
        lightboxImage.classList.add('loaded');
      };
    }

    function nextImage() {
      currentIndex = (currentIndex + 1) % images.length;
      updateImage();
    }

    function prevImage() {
      currentIndex = (currentIndex - 1 + images.length) % images.length;
      updateImage();
    }

    // Thumbnail clicks
    thumbnails.forEach((thumb) => {
      thumb.addEventListener('click', () => {
        const index = parseInt(thumb.getAttribute('data-index') || '0', 10);
        openLightbox(index);
      });
    });

    // Close handlers
    closeBtn?.addEventListener('click', closeLightbox);
    backdrop?.addEventListener('click', closeLightbox);

    // Navigation handlers
    prevBtn?.addEventListener('click', prevImage);
    nextBtn?.addEventListener('click', nextImage);

    // Keyboard navigation
    document.addEventListener('keydown', (e) => {
      if (lightbox?.hasAttribute('hidden')) return;

      switch (e.key) {
        case 'Escape':
          closeLightbox();
          break;
        case 'ArrowLeft':
          prevImage();
          break;
        case 'ArrowRight':
          nextImage();
          break;
      }
    });

    // Touch/swipe support
    lightbox?.addEventListener('touchstart', (e) => {
      touchStartX = (e as TouchEvent).changedTouches[0].screenX;
    });

    lightbox?.addEventListener('touchend', (e) => {
      touchEndX = (e as TouchEvent).changedTouches[0].screenX;
      handleSwipe();
    });

    function handleSwipe() {
      const swipeThreshold = 50;
      const diff = touchStartX - touchEndX;

      if (Math.abs(diff) > swipeThreshold) {
        if (diff > 0) {
          nextImage();
        } else {
          prevImage();
        }
      }
    }
  });
</script>
